(()=>{let e;var t;(t=e||(e={}))[t.toyota2ndGen4Runner=0]="toyota2ndGen4Runner",t[t.bmwE36M3=1]="bmwE36M3";var a=e;var r=a.toyota2ndGen4Runner;var o=Object.fromEntries([[a.toyota2ndGen4Runner,{shape:[{x:2,y:45},{x:3,y:34},{x:10,y:24},{x:48,y:24},{x:57,y:31},{x:67,y:32},{x:77,y:36},{x:77,y:43}],headlights:{x:76,y:38},brakelights:{x:4,y:39},extension:{left:2,right:77},width:75,bottom:55}],[a.bmwE36M3,{shape:[{x:4,y:45},{x:6,y:38},{x:11,y:38},{x:24,y:32},{x:41,y:32},{x:57,y:40},{x:71,y:42},{x:74,y:47}],headlights:{x:72,y:45},brakelights:{x:6,y:42},extension:{left:4,right:74},width:70,bottom:55}]]);const n={detectCircleCircleCollision:(e,t)=>Math.hypot(e.loc.x-t.loc.x,e.loc.y-t.loc.y)-e.radius-t.radius<1,detectCircleHeroCollision:(e,t)=>{const a=o[r].shape.map((e=>({x:t.loc.x+e.x,y:t.loc.y+e.y})));return n.polyCircle(a,e.loc.x,e.loc.y,e.radius)},detected:e=>{const t=(e,a)=>{const[r,...o]=e;return void 0!==r&&(n.detectCircleHeroCollision(r,a)||t(o,a))};return t(e.comets,e.hero)},polyCircle:(e,t,a,r)=>{let o=0;for(let s=0;s<e.length;s++){o=s+1,o==e.length&&(o=0);if(n.lineCircle(e[s].x,e[s].y,e[o].x,e[o].y,t,a,r))return!0}return!1},lineCircle:(e,t,a,r,o,s,c)=>{const l=n.pointCircle(e,t,o,s,c),d=n.pointCircle(a,r,o,s,c);if(l||d)return!0;const i=e-a,g=t-r,h=((o-e)*(a-e)+(s-t)*(r-t))/Math.sqrt(i*i+g*g)**2,m=e+h*(a-e),x=t+h*(r-t);if(!n.linePoint(e,t,a,r,m,x))return!1;const u=m-o,w=x-s;return Math.sqrt(u*u+w*w)<=c},linePoint:(e,t,a,r,o,n)=>{const s=Math.hypot(o-e,n-t),c=Math.hypot(o-a,n-r),l=Math.hypot(e-a,t-r);return s+c>=l-.1&&s+c<=l+.1},pointCircle:(e,t,a,r,o)=>Math.hypot(e-a,t-r)<=o};var s=n;const c={getRandomInt:(e,t)=>Math.floor(t()*e),generate:(e,t,a)=>{const r=1+c.getRandomInt(2,a);return[...Array(r).keys()].map((()=>c.new(e,t,a)))},new:(e,t,a)=>{const r=a()*e,o=10*a()+10,n={x:r,y:-o},s=a(),c=s<=.33?"#FFAA00":s<=.66?"#FC9303":"#FF7B00",l=-1*(a()+.5);return{loc:n,radius:o,color:c,dy:10,dx:l,yLimit:t,rotation:Math.atan(Math.abs(l)/10)}},update:e=>{const t=e.loc.y+e.dy,a=e.loc.x+e.dx,r={...e.loc,y:t,x:a};return{...e,loc:r}},updateAll:e=>{const t=(e,a)=>{const[r,...o]=e;return void 0===r?a:r.loc.y<=r.yLimit+346?t(o,a.concat([c.update(r)])):t(o,a)};return t(e,[])}};var l=c;const d=innerWidth<508?innerWidth:508,i=innerHeight<500?innerHeight:500,g={new:()=>({loc:{x:5-o[r].extension.left,y:i-o[r].bottom-100},dx:0,width:o[r].width,color:"#959088",swayCounter:0,isIdling:!0,isBraking:!1,drift:0,distanceTravelled:0}),update:e=>{const t=g.calcSway(e.swayCounter),a=e.loc.x-o[r].extension.left<=5+t,n=e.loc.x+o[r].extension.right>d,s=e.dx<0,c=0==e.dx,l=e.drift+.1,i=l+e.loc.x/20;if(n){const t=0,a=d-o[r].extension.right,n={...e.loc,x:a},c=!1,g=360;return{...e,loc:n,dx:t,isIdling:c,isBraking:s,drift:l,distanceTravelled:i,swayCounter:g}}if(a&&(c||s)){const t=(e.swayCounter+1)%360,a=0,n=5+g.calcSway(t),c=n>=0?n-o[r].extension.left:0-o[r].extension.left,d={...e.loc,x:c},h=!0;return{...e,loc:d,dx:a,swayCounter:t,isIdling:h,isBraking:s,drift:l,distanceTravelled:i}}{const t=e.dx+-.8,a=e.loc.x+t,r=a>=0?a:0,o={...e.loc,x:r},n=!1,c=360;return{...e,loc:o,dx:t,isIdling:n,isBraking:s,drift:l,distanceTravelled:i,swayCounter:c}}},rev:e=>({...e,dx:10}),calcSway:e=>5*Math.sin(Math.PI/180*5*e)};var h=g;let m;var x;(x=m||(m={}))[x.Background=0]="Background",x[x.Comet=1]="Comet";var u=m;var w={x:d/2,color:"#fffce3",align:"center"};const y={drawCircle:(e,t,a,r,o)=>{e.beginPath(),e.arc(t,a,r,0,2*Math.PI,!1),e.fillStyle=o,e.fill()},drawText:(e,t,a={})=>{const r={...t,...a};e.fillStyle=r.color,e.font=`${r.fontSize}px PressStart`,e.textAlign=r.align,e.fillText(r.copy,r.x,r.y)},drawCenteredText:(e,t,a,r,o,n={})=>{const s=a+r/2+o/2;y.drawText(e.ctx,{...w,copy:t,y:s,fontSize:o},n)},drawDeadCenteredText:(e,t,a,r={})=>{const o=(i+a)/2;y.drawText(e.ctx,{...w,copy:t,y:o,fontSize:a},r)},drawCenteredPhrases:(e,t,a,r,o,n={})=>{const s=a+r/2+o/2;t.forEach(((t,a)=>{const r=s+a*o*1.1;y.drawText(e.ctx,{...w,copy:t,y:r,fontSize:o},n)}))},drawStretchedImage:(e,t,a={})=>{const r={...t,...a};e.ctx.drawImage(r.img,r.x,r.y,r.targetWidth,r.targetHeight)},drawImage:(e,t,a,r,o={})=>{const n={img:t,x:a,y:r,targetWidth:t.width,targetHeight:t.height};y.drawStretchedImage(e,n,o)},drawCenteredImage:(e,t,a,r,o={})=>{const n=r/t.width,s=t.height*n,c={img:t,x:(d-r)/2,y:a,targetWidth:r,targetHeight:s};y.drawStretchedImage(e,c,o)},drawDeadCenteredImage:(e,t,a,r={})=>{const o=a/t.width,n=t.height*o,s=(i-n)/2;y.drawCenteredImage(e,t,s,a,r)},drawFullWidthDeadCenteredImage:(e,t,a={})=>{y.drawDeadCenteredImage(e,t,d,a)},clearScreen:e=>{y.eraseAllScreen(e),y.fillBackground(e,"#12110b")},eraseScreen:e=>{e.ctx.clearRect(0,0,d,i)},eraseAllScreen:e=>{y.eraseScreen(e,0,0,d,i)},fillDefaultBackground:e=>{y.fillBackground(e,"#12110b")},fillBackground:(e,t)=>{e.ctx.fillStyle=t,e.ctx.fillRect(0,0,d,i)}};var f=y;const p={drawHero:(e,t)=>{const a=e.carImages[0];if(e.ctx.drawImage(a,t.loc.x,t.loc.y),t.isBraking){const a=t.loc.x+o[r].brakelights.x,n=t.loc.y+o[r].brakelights.y,s=10,c=20,l=`rgb(255, 0, 0, ${.35})`,d=`rgb(255, 0, 0, ${.15})`;f.drawCircle(e.ctx,a,n,s,l),f.drawCircle(e.ctx,a,n,c,d)}},drawExhaust:(e,t)=>{t.forEach((t=>{f.drawCircle(e,t.loc.x,t.loc.y,t.radius,t.alphaColor.color())}))},drawComets:(e,t)=>{t.forEach((t=>{const a=2*t.radius/100,r=e.assets[u.Comet],o=130*a*.5,n=346*a*.8,s=t.loc.x-o,c=t.loc.y-n,l=130*a,d=346*a;e.ctx.translate(t.loc.x,t.loc.y),e.ctx.rotate(t.rotation),e.ctx.drawImage(r,s-t.loc.x,c-t.loc.y,l,d),e.ctx.rotate(-t.rotation),e.ctx.translate(-t.loc.x,-t.loc.y)}))},drawForeground:(e,t)=>{t.rear.concat(t.mid).concat(t.fore).forEach((t=>{const a=e.nightImages[t.imageIndex];f.drawImage(e,a,t.loc.x,t.loc.y)}))},drawHeadlights:(e,t,a)=>{const n=t.loc.x+o[r].headlights.x,s=t.loc.y+o[r].headlights.y,c=s-250,l=s+70;e.ctx.save(),e.ctx.beginPath(),e.ctx.moveTo(n,s),e.ctx.lineTo(n+500,c),e.ctx.lineTo(n+500,l),e.ctx.clip(),a.fore.forEach((t=>{const a=e.dayImages[t.imageIndex];f.drawImage(e,a,t.loc.x,t.loc.y)})),e.ctx.restore()},drawBackgroundImage:e=>{const t=e.assets[u.Background];f.drawFullWidthDeadCenteredImage(e,t)},drawDistanceTravelled:(e,t)=>{const a=`${t}m`,r=d-10;f.drawText(e.ctx,{...w,copy:a,x:r,y:35,fontSize:25,align:"right"})},drawMontage:(e,t)=>a=>f.drawFullWidthDeadCenteredImage(e,t[a]),drawIntro:e=>{const t=.33*i,a=e.carImages[1],r=.9*d,o=.1*t,n=0+o,s=t-o,c=n+s,l=.2*s;f.clearScreen(e),f.drawCenteredImage(e,a,c,r),f.drawCenteredText(e,"1994 4Runner",n,s,l)},getGameOverDrawers:(e,t)=>{const a=.33*i,r=e.carImages[1],o=(i-r.height)/2,n=r.height,s=0+.1*a,c=o-s,l=o+n,g=.5*(i-l),h=l+g,m=i-h,x=.9*c,u=.2*g,w=`${u}px PressStart`,y=`You were killed by flying molten lava after travelling ${t}m`,C=p.breakCopyIntoPhrases(e.ctx,y,w,.75*d);return[()=>f.drawCenteredText(e,"RIP",s,c,x),()=>f.drawCenteredImage(e,r,o,r.width),()=>f.drawCenteredPhrases(e,C,l,g,u),h,m]},breakCopyIntoPhrases:(e,t,a,r)=>{e.font=a;const o=" ",n=r,s=(t,a,r)=>{const[c,...l]=t;if(void 0===c)return r.concat([a.join(o)]);const d=a.concat([c]);return e.measureText(d.join(o)).width<n?s(l,d,r):s(l,[],r.concat([d.join(o)]))};return s(t.split(o),[],[])}};var C=p;let v;var I;(I=v||(v={}))[I.Locked=0]="Locked",I[I.ClickToStart=1]="ClickToStart",I[I.Playing=2]="Playing";var k=v;var S=e=>{let t=2654435769,a=608135816,r=3084996962;const o=()=>{t>>>=0,a>>>=0,r>>>=0;let o=t+a|0;return t=a^a>>>9,a=r+(r<<3)|0,r=r<<21|r>>>11,o=o+(e=(e>>>=0)+1|0)|0,r=r+o|0,(o>>>0)/4294967296};for(let e=0;e<15;e++)o();return o};const b=762;var M={new:()=>{const e={loc:{x:0,y:i-375-50},imageIndex:0},t={loc:{x:0,y:i-375-50-25},imageIndex:0},a={loc:{x:0,y:i-375-50-50},imageIndex:0};return{fore:[e,{...e,loc:{...e.loc,x:b}}],mid:[t,{...t,loc:{...t.loc,x:b}}],rear:[a,{...a,loc:{...a.loc,x:b}}]}},update:e=>{const t=(e,r,o)=>{const[n,...s]=e;if(void 0===n)return r;const c=n.loc.x+o;if(c>-762){const e={...n.loc,x:c};return t(s,r.concat([{...n,loc:e}]),o,a)}const l=a(),d={...n.loc,x:c+1524};return t(s,r.concat([{...n,imageIndex:l,loc:d}]),o,a)},a=()=>Math.random()>.6?1+Math.floor(7*Math.random()):0,r=()=>0;return{fore:t(e.fore,[],-5,a),mid:t(e.mid,[],-2.5,r),rear:t(e.rear,[],-1.25,r)}}};var P=class{constructor(e,t,a,r){this.color=()=>`rgb(${this.r}, ${this.g}, ${this.b}, ${this.alpha})`,this.r=e,this.g=t,this.b=a,this.alpha=r}};const T={new:(e,t,a,r,o)=>({loc:e,radius:t,alphaColor:o,dx:a,dy:r,age:0}),maybeNewCarExhaust:(e,t)=>{const a=T.calcAlpha(0),r=new P(100,150,200,a),o=t?T.lowLikelihoodOfSmoke():T.highLikelihoodOfSmoke(),n=Math.random()-.5;return o.map((t=>T.new(e,t,-10,n,r)))},maybeNewCometExhaust:e=>{const t=T.calcAlpha(0),a=new P(100,150,200,t);return T.highLikelihoodOfSmoke().map((t=>T.new(e,t,1,-15,a)))},update:e=>{const t=e.loc.x+e.dx,a=e.loc.y+e.dy,r={...e.loc,x:t,y:a},o=e.age+1,n=T.calcAlpha(o),s=new P(e.alphaColor.r,e.alphaColor.g,e.alphaColor.b,n),c=e.radius+1;return{...e,loc:r,age:o,alphaColor:s,radius:c}},updateAll:e=>e.flatMap((e=>{const t=e.age>100,a=e.loc.x+e.radius<0,r=e.loc.y+e.radius<0;return t||a||r?[]:[T.update(e)]})),highLikelihoodOfSmoke:()=>Math.random()>.01?[25*Math.random()]:[],lowLikelihoodOfSmoke:()=>Math.random()>.75?[10*Math.random()]:[],calcAlpha:e=>.00133*(100-4*e)};var E=T;var A={new:()=>({hero:h.new(),carExhaust:[],cometExhaust:[],comets:[],foreground:M.new(),cometRand:S(3735928559)}),update:(e,t)=>{const a=h.update(e.hero),n=l.updateAll(e.comets),s=n.flatMap((e=>E.maybeNewCometExhaust(e.loc))),c=E.updateAll(e.cometExhaust).concat(s),d=E.maybeNewCarExhaust({x:e.hero.loc.x+o[r].brakelights.x,y:e.hero.loc.y+o[r].brakelights.y},e.hero.isIdling),i=E.updateAll(e.carExhaust).concat(d),g=M.update(e.foreground);t({...e,hero:a,carExhaust:i,cometExhaust:c,comets:n,foreground:g})}};const B={getMontageDrawers:(e,t)=>{const a=C.drawMontage(e,t),r=t[0].height,o=()=>{const t=(i-r)/2+r,a=i-t,o=.12*a;f.drawCenteredText(e,"skip",t,a,o,{color:"#929082"})},n=async t=>{f.clearScreen(e),o(),await R(1),a(t),await R(2)};return[async()=>{f.clearScreen(e);const t=.33*i,a=.33*i,r=.12*a;f.drawCenteredText(e,"joey stockermans 2022",t,a,r),o(),await R(2)},()=>n(0),()=>n(1),()=>n(2),()=>n(3),()=>n(4),()=>n(5),()=>n(6),async()=>{f.clearScreen(e),await R(1);const t=.33*i,a=.33*i,r=.12*a;f.drawCenteredText(e,"Escape from Las Palmas",t,a,r),await R(2)},async()=>{const t=.66*i,a=.33*i,r=.12*a;f.drawCenteredText(e,"Press start",t,a,r)}]},drawGameOver:(e,t,a)=>{const[r,o,n,s,c]=C.getGameOverDrawers(t,Math.floor(a));(async()=>{await R(1),f.clearScreen(t),r(),o(),n(),await R(1),e(k.ClickToStart);const a=.2*c;f.drawCenteredText(t,"Ok",s,c,a)})()},draw:(e,t)=>{f.clearScreen(t),C.drawBackgroundImage(t),C.drawForeground(t,e.foreground),C.drawDistanceTravelled(t,Math.floor(e.hero.distanceTravelled)),C.drawHero(t,e.hero),C.drawHeadlights(t,e.hero,e.foreground),C.drawExhaust(t.ctx,e.carExhaust.concat(e.cometExhaust)),C.drawComets(t,e.comets)},startNewGame:(e,t)=>{e(A.new()),t(k.Playing)},revEngine:(e,t)=>{const a=h.rev(e.hero);t({...e,hero:a})},addComets:(e,t)=>{const a=e.comets.concat(l.generate(d,i,e.cometRand));t({...e,comets:a})},addCometTime:(e,t)=>e-t>=200&&e%125==0},R=e=>new Promise((t=>setTimeout(t,1e3*e)));var F=B;const D=["../assets/misc/background.png","../assets/misc/comet.png"].map((e=>new Promise((t=>{const a=new Image;a.onload=()=>t(a),a.src=e}))));var _=Promise.all(D);const G=["../assets/foreground/night.png","../assets/foreground/night_v1.png","../assets/foreground/night_v2.png","../assets/foreground/night_v3.png","../assets/foreground/night_v4.png","../assets/foreground/night_v5.png","../assets/foreground/night_v6.png","../assets/foreground/night_v7.png"].map((e=>new Promise((t=>{const a=new Image;a.onload=()=>t(a),a.src=e}))));var L=Promise.all(G);const O=["../assets/foreground/day.png","../assets/foreground/day_v1.png","../assets/foreground/day_v2.png","../assets/foreground/day_v3.png","../assets/foreground/day_v4.png","../assets/foreground/day_v5.png","../assets/foreground/day_v6.png","../assets/foreground/day_v7.png"].map((e=>new Promise((t=>{const a=new Image;a.onload=()=>t(a),a.src=e}))));var H=Promise.all(O);const $=["../assets/montage/01.png","../assets/montage/02.png","../assets/montage/03.png","../assets/montage/04.png","../assets/montage/05.png","../assets/montage/06.png","../assets/montage/07.png"].map((e=>new Promise((t=>{const a=new Image;a.onload=()=>t(a),a.src=e}))));var W=Promise.all($);const j=Object.fromEntries([[a.toyota2ndGen4Runner,["../assets/car/toyota2ndGen4Runner/small.png","../assets/car/toyota2ndGen4Runner/large.png"]],[a.bmwE36M3,["../assets/car/bmwE36M3/small.png","../assets/car/bmwE36M3/large.png"]]])[r].map((e=>new Promise((t=>{const a=new Image;a.onload=()=>t(a),a.src=e}))));var N=Promise.all(j);const z=[{name:"PressStart",url:"url(../assets/fonts/PressStart2P-Regular.ttf)"}].map((e=>new FontFace(e.name,e.url).load()));var q=Promise.all(z);var Y={new:(e,t,a,r,o,n)=>{e.width=d,e.height=i,document.fonts.add(n[0]);const s=(e=>{if(e)return e;throw new Error("Failed to get 2D context")})(e.getContext("2d"));return{canvas:e,ctx:s,assets:t,nightImages:a,dayImages:r,carImages:o,fonts:n}}};const J=document.getElementById("game");let K;const Q=e=>{K=e};let U,V=k.ClickToStart;const X=e=>{V=e};let Z=0;_.then((e=>{N.then((t=>{L.then((a=>{H.then((r=>{W.then((o=>{q.then((n=>{U=Y.new(J,e,a,r,t,n);const s=F.getMontageDrawers(U,o);te(s)}))}))}))}))}))}));const ee=()=>{const e=requestAnimationFrame(ee);F.addCometTime(e,Z)&&F.addComets(K,Q),A.update(K,Q),F.draw(K,U),s.detected(K)&&(cancelAnimationFrame(e),Z=e,X(k.Locked),F.drawGameOver(X,U,K.hero.distanceTravelled))},te=e=>{const[t,...a]=e;void 0!==t&&t().then((()=>{V!=k.Playing&&te(a)}))};J.addEventListener("click",(()=>{switch(V){case k.Locked:break;case k.ClickToStart:F.startNewGame(Q,X),ee();break;case k.Playing:F.revEngine(K,Q)}}))})();
//# sourceMappingURL=main.js.map
