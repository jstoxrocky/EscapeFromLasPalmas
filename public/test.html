<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>
    <script>
(()=>{const i={detectCircleCircleCollision:(e,t)=>Math.hypot(e.loc.x-t.loc.x,e.loc.y-t.loc.y)-e.radius-t.radius<1,detectCircleRectCollision:(e,t)=>{var a={x:t.loc.x+3,y:t.loc.y+46},r={x:t.loc.x+4,y:t.loc.y+35},o={x:t.loc.x+11,y:t.loc.y+25},n={x:t.loc.x+49,y:t.loc.y+25},c={x:t.loc.x+58,y:t.loc.y+32},l={x:t.loc.x+78,y:t.loc.y+37},t={x:t.loc.x+78,y:t.loc.y+44};return i.polyCircle([a,r,o,n,c,l,t],e.loc.x,e.loc.y,e.radius)},detected:e=>i.detectedHeroComets(e.hero,e.comets),detectedHeroComets:(e,t)=>{var[a,...t]=t;return void 0!==a&&(!!i.detectCircleRectCollision(a,e)||i.detectedHeroComets(e,t))},polyCircle:(t,a,r,o)=>{let n=0;for(let e=0;e<t.length;e++)if(n=e+1,n==t.length&&(n=0),i.lineCircle(t[e].x,t[e].y,t[n].x,t[n].y,a,r,o))return!0;return!1},lineCircle:(e,t,a,r,o,n,c)=>{var l=i.pointCircle(e,t,o,n,c),s=i.pointCircle(a,r,o,n,c);if(l||s)return!0;l=e-a,s=t-r,l=((o-e)*(a-e)+(n-t)*(r-t))/Math.sqrt(l*l+s*s)**2,s=e+l*(a-e),l=t+l*(r-t);if(!i.linePoint(e,t,a,r,s,l))return!1;o=s-o,n=l-n;return Math.sqrt(o*o+n*n)<=c},linePoint:(e,t,a,r,o,n)=>{var c=Math.hypot(o-e,n-t),n=Math.hypot(o-a,n-r),r=Math.hypot(e-a,t-r);return r-.1<=c+n&&c+n<=r+.1},pointCircle:(e,t,a,r,o)=>Math.hypot(e-a,t-r)<=o};var t=i;const o={getRandomInt:(e,t)=>Math.floor(t()*e),generate:(e,t,a)=>{var r=1+o.getRandomInt(2,a);return[...Array(r).keys()].map(()=>o.new(e,t,a))},new:(e,t,a)=>{var r=a()*e,o=10*a()+10,e={x:r,y:-o},r=a(),r=r<=.33?"#FFAA00":r<=.66?"#FC9303":"#FF7B00",a=-1*(a()+.5);return{loc:e,radius:o,color:r,dy:10,dx:a,yLimit:t,rotation:Math.atan(Math.abs(a)/10)}},update:e=>{var t=e.loc.y+e.dy,a=e.loc.x+e.dx,a={...e.loc,y:t,x:a};return{...e,loc:a}},updateAll:e=>{const r=(e,t)=>{var[a,...e]=e;return void 0===a?t:a.loc.y<=a.yLimit+346?r(e,t.concat([o.update(a)])):r(e,t)};return r(e,[])}};var l=o;const d={new:(e,t,a)=>({loc:{y:t-80-70,x:5},dx:0,width:80,height:80,color:"#959088",xLimit:e,swayCounter:0,isIdling:!0,isBraking:!1,imageIndex:a,drift:0,distanceTravelled:0}),update:e=>{const t=d.calcSway(e.swayCounter),a=e.loc.x<=5+t,r=e.width,o=e.xLimit-r,n=e.loc.x>o,c=e.dx<0,l=0==e.dx,s=e.drift+.1,i=s+e.loc.x/20;if(n){const t=0,a=o,r={...e.loc,x:a},d=!1;return{...e,loc:r,dx:0,isIdling:!1,isBraking:c,drift:s,distanceTravelled:i}}if(a&&(l||c)){const t=(e.swayCounter+1)%360,a=0,r=5+d.calcSway(t),o=0<=r?r:0,n={...e.loc,x:o},l=!0;return{...e,loc:n,dx:0,swayCounter:t,isIdling:!0,isBraking:c,drift:s,distanceTravelled:i}}{const t=e.dx+-.8,a=e.loc.x+t,r=0<=a?a:0,d={...e.loc,x:r},o=!1;return{...e,loc:d,dx:t,isIdling:!1,isBraking:c,drift:s,distanceTravelled:i}}},rev:e=>({...e,dx:10}),calcSway:e=>5*Math.sin(Math.PI/180*5*e)};var s=d;const n={new:(e,t,a,r)=>({loc:e,radius:t,color:n.exhaustColor(0),dx:a,dy:r,age:0}),maybeNew:(t,e)=>n.getRadius(e).map(e=>n.new(t,e,-10,Math.random()-.5)),maybeNewSmoke:t=>n.getRadius(!1).map(e=>n.new(t,e,1,-15)),update:e=>{var t=e.loc.x+e.dx,a=e.loc.y+e.dy,r={...e.loc,x:t,y:a},o=e.age+1,t=e.radius+1,a=n.exhaustColor(o);return{...e,loc:r,age:o,color:a,radius:t}},updateAll:e=>e.flatMap(e=>{var t=100<e.age,a=e.loc.x+e.radius<0,r=e.loc.y+e.radius<0;return t||a||r?[]:[n.update(e)]}),getRadius:e=>e?.75<Math.random()?[10*Math.random()]:[]:.01<Math.random()?[25*Math.random()]:[],exhaustColor:e=>`rgb(100, 150, 200, ${.00133*(100-4*e)})`};var x=n;let e;e={Small:0,0:"Small",Large:1,1:"Large",Background:2,2:"Background",Comet:3,3:"Comet"};var N=e;const g={drawCircle:(e,t,a,r,o)=>{e.beginPath(),e.arc(t,a,r,0,2*Math.PI,!1),e.fillStyle=o,e.fill()},drawHero:(e,t)=>{const a=e.assets[t.imageIndex];if(e.ctx.drawImage(a,t.loc.x,t.loc.y),t.isBraking){const a=t.loc.x+5,r=t.loc.y+t.height/2;g.drawCircle(e.ctx,a,r,10,"rgb(255, 0, 0, 0.35)"),g.drawCircle(e.ctx,a,r,20,"rgb(255, 0, 0, 0.15)")}},drawExhaust:(t,e)=>{e.forEach(e=>{g.drawCircle(t,e.loc.x,e.loc.y,e.radius,e.color)})},drawComets:(c,e)=>{e.forEach(e=>{var t=2*e.radius/100,a=c.assets[N.Comet],r=e.loc.x-130*t*.5,o=e.loc.y-346*t*.8,n=130*t,t=346*t;c.ctx.translate(e.loc.x,e.loc.y),c.ctx.rotate(e.rotation),c.ctx.drawImage(a,r-e.loc.x,o-e.loc.y,n,t),c.ctx.rotate(-e.rotation),c.ctx.translate(-e.loc.x,-e.loc.y)})},drawForeground:(a,e)=>{e.rear.concat(e.mid).concat(e.fore).forEach(e=>{var t=a.nightImages[e.imageIndex];a.ctx.drawImage(t,e.loc.x,e.loc.y)})},drawHeadlights:(a,e,t)=>{var r=e.loc.x+e.width,o=e.loc.y+e.height/2,n=o-250,e=o+70;a.ctx.save(),a.ctx.beginPath(),a.ctx.moveTo(r,o),a.ctx.lineTo(r+500,n),a.ctx.lineTo(r+500,e),a.ctx.clip(),t.fore.forEach(e=>{var t=a.dayImages[e.imageIndex];a.ctx.drawImage(t,e.loc.x,e.loc.y)}),a.ctx.restore()},drawBackground:e=>{var t=e.assets[N.Background];e.ctx.drawImage(t,0,0)},drawScore:(e,t,a)=>{t+="m",a-=10;e.ctx.fillStyle="#b0ae9b",e.ctx.font="25px PressStart",e.ctx.textAlign="right",e.ctx.fillText(t,a,35)},drawStart:(e,t,a,r,o,n,c)=>{t/=2,o=r+o/2+n/2;e.ctx.fillStyle="#fffce3",e.ctx.font=n+"px PressStart",e.ctx.textAlign="center",e.ctx.fillText(c,t,o)},drawIntro:(e,t,a)=>{var r=.33*a,o=t/2,n=e.assets[N.Large],c=.9*t,l=c/n.width,s=n.height*l,i=.1*r,d=0+i,x=r-i,l=.2*x,r=o,i=o-c/2,o=d+x/2+l/2,x=d+x;g.clearCanvas(e,t,a),g.fillDefaultBackground(e,t,a),e.ctx.drawImage(n,i,x,c,s),e.ctx.fillStyle="#fffce3",e.ctx.font=l+"px PressStart",e.ctx.textAlign="center",e.ctx.fillText("1994 4Runner",r,o)},getGameOverDrawers:(a,e,t,r)=>{const o="#fffce3",n="center",c=.33*r,l=t/2,s=a.assets[N.Large],i=.9*t,d=i/s.width,x=s.height*d,g=.1*c,u=0+g,m=.6*c,h=u+m,f=c-g-m,y=h+f,v=y+x,w=f,p=v+w,C=r-p,S=.9*m,I=.3*f,k=.25*w,P=S+"px PressStart",M=I+"px PressStart",T=k+"px PressStart",B="1994 - "+(new Date).getFullYear(),b=`You were killed by flying molten lava after travelling ${e}m`,A=z(a.ctx,b,T,.75*t),F=l,L=l,R=l-i/2,_=l,E=u+m/2+S/2,H=h+f/2+I/2,D=y,G=v+w/2+k/2;return[()=>{a.ctx.fillStyle=o,a.ctx.font=P,a.ctx.textAlign=n,a.ctx.fillText("RIP",F,E)},()=>a.ctx.drawImage(s,R,D,i,x),()=>{a.ctx.fillStyle=o,a.ctx.font=M,a.ctx.textAlign=n,a.ctx.fillText(B,L,H)},()=>{a.ctx.fillStyle=o,a.ctx.font=T,a.ctx.textAlign=n,A.forEach((e,t)=>{a.ctx.fillText(e,_,G+t*k*1.1)})},p,C]},clearCanvas:(e,t,a)=>{e.ctx.clearRect(0,0,t,a)},fillDefaultBackground:(e,t,a)=>{e.ctx.fillStyle="#1e1d12",e.ctx.fillRect(0,0,t,a)},getFontSize:(e,t,a,r)=>(e.font="1px "+a,r/e.measureText(t).width)},z=(n,e,t,a)=>{n.font=t;const c=a,l=(e,t,a)=>{var[r,...e]=e;if(void 0===r)return a.concat([t.join(" ")]);const o=t.concat([r]);return n.measureText(o.join(" ")).width<c?l(e,o,a):l(e,[],a.concat([o.join(" ")]))};return l(e.split(" "),[],[])};var u=g;let a;a={Locked:0,0:"Locked",ClickToStart:1,1:"ClickToStart",Playing:2,2:"Playing"};var c=a;var r=e=>{var t={loc:{x:0,y:e-375-50},imageIndex:0},a={loc:{x:0,y:e-375-50-25},imageIndex:0},e={loc:{x:0,y:e-375-50-50},imageIndex:0};return{fore:[t,{...t,loc:{...t.loc,x:762}}],mid:[a,{...a,loc:{...a.loc,x:762}}],rear:[e,{...e,loc:{...e.loc,x:762}}]}},m=e=>{const l=(e,t,a)=>{var[r,...o]=e;if(void 0===r)return t;var n=r.loc.x+a;if(-762<n){const c={...r.loc,x:n};return l(o,t.concat([{...r,loc:c}]),a,s)}e=s(),n={...r.loc,x:n+1524};return l(o,t.concat([{...r,imageIndex:e,loc:n}]),a,s)},s=()=>.6<Math.random()?1+Math.floor(7*Math.random()):0;return{fore:l(e.fore,[],-5,s),mid:l(e.mid,[],-2.5),rear:l(e.rear,[],-1.25)}};const h=innerWidth<508?innerWidth:508,f=innerHeight<500?innerHeight:500;const y={initializeState:()=>({hero:s.new(h,f,N.Small),exhaustClouds:[],comets:[],blocks:[],score:0,foreground:r(f),cometRand:(t=>{let a=2654435769,r=608135816,o=3084996962;var n=()=>{a>>>=0,r>>>=0,o>>>=0;var e=a+r|0;return a=r^r>>>9,r=o+(o<<3)|0,o=o<<21|o>>>11,e=e+(t=1+(t>>>0)|0)|0,o=o+e|0,(e>>>0)/4294967296};for(let e=0;e<15;e++)n();return n})(3735928559)}),initializeCanvas:(e,t,a,r,o)=>{e.width=h,e.height=f,document.fonts.add(o[0]);var n=y.checkContext(e.getContext("2d"));return{canvas:e,ctx:n,assets:t,nightImages:a,dayImages:r,fonts:o}},drawIntro:(e,t)=>{u.drawIntro(t,h,f);const a=.66*f,r=.33*f,o=.12*r;v(1).then(()=>y.displayStartButton(e,t,"Press start",a,r,o))},addComets:(e,t)=>{var a=e.comets.concat(l.generate(h,f,e.cometRand));t({...e,comets:a})},update:(e,t)=>{const a=s.update(e.hero),r=l.updateAll(e.comets),o=r.flatMap(e=>x.maybeNewSmoke(e.loc)),n=x.updateAll(e.exhaustClouds).concat(o).concat(x.maybeNew({...e.hero.loc,y:e.hero.loc.y+e.hero.height/2},e.hero.isIdling)),c=m(e.foreground);t({...e,hero:a,exhaustClouds:n,comets:r,foreground:c})},draw:(e,t)=>{u.clearCanvas(t,h,f),u.fillDefaultBackground(t,h,f),u.drawBackground(t),u.drawForeground(t,e.foreground),u.drawScore(t,Math.floor(e.hero.distanceTravelled),h),u.drawHero(t,e.hero),u.drawHeadlights(t,e.hero,e.foreground),u.drawExhaust(t.ctx,e.exhaustClouds),u.drawComets(t,e.comets)},handleCollision:(e,t,a)=>{v(1).then(()=>y.drawGameOver(e,t,a))},startNewGame:(e,t)=>{e(y.initializeState()),t(c.Playing)},revEngine:(e,t)=>{var a=s.rev(e.hero);t({...e,hero:a})},checkContext:e=>{if(e)return e;throw new Error("Failed to get 2D context")},displayStartButton:(e,t,a,r,o,n)=>{e(c.ClickToStart),u.drawStart(t,h,f,r,o,n,a)},drawGameOver:(t,a,e)=>{const[r,o,n,c,l,s]=u.getGameOverDrawers(a,Math.floor(e),h,f);u.clearCanvas(a,h,f),u.fillDefaultBackground(a,h,f),r(),o(),n(),c(),v(1).then(()=>{var e=.2*s;y.displayStartButton(t,a,"Ok",l,s,e)})},addCometTime:(e,t)=>200<=e-t&&e%125==0},v=t=>new Promise(e=>setTimeout(e,1e3*t));var w=y,p=["../assets/car/small.png","../assets/car/large.png","../assets/misc/background.png","../assets/misc/comet.png"].map(a=>new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=a})),C=Promise.all(p),p=["../assets/foreground/night.png","../assets/foreground/night_v1.png","../assets/foreground/night_v2.png","../assets/foreground/night_v3.png","../assets/foreground/night_v4.png","../assets/foreground/night_v5.png","../assets/foreground/night_v6.png","../assets/foreground/night_v7.png"].map(a=>new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=a})),S=Promise.all(p),p=["../assets/foreground/day.png","../assets/foreground/day_v1.png","../assets/foreground/day_v2.png","../assets/foreground/day_v3.png","../assets/foreground/day_v4.png","../assets/foreground/day_v5.png","../assets/foreground/day_v6.png","../assets/foreground/day_v7.png"].map(a=>new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=a})),I=Promise.all(p),p=[{name:"PressStart",url:"url(../assets/fonts/PressStart2P-Regular.ttf)"}].map(e=>new FontFace(e.name,e.url).load()),k=Promise.all(p);const P=document.getElementById("game");let M;const T=e=>{M=e};let B,b=c.Locked;const A=e=>{b=e};let F=0;C.then(r=>{S.then(a=>{I.then(t=>{k.then(e=>{B=w.initializeCanvas(P,r,a,t,e),w.drawIntro(A,B)})})})});const L=()=>{var e=requestAnimationFrame(L);w.addCometTime(e,F)&&w.addComets(M,T),w.update(M,T),w.draw(M,B),t.detected(M)&&(cancelAnimationFrame(e),F=e,A(c.Locked),w.handleCollision(A,B,M.hero.distanceTravelled))};P.addEventListener("click",()=>{switch(b){case c.Locked:break;case c.ClickToStart:w.startNewGame(T,A),L();break;case c.Playing:w.revEngine(M,T)}})})();
    </script>
    </body>
</html>
