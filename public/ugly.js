(()=>{let e;e={toyota2ndGen4Runner:0,0:"toyota2ndGen4Runner",bmwE36M3:1,1:"bmwE36M3"};var a=e,d=a.toyota2ndGen4Runner,i=Object.fromEntries([[a.toyota2ndGen4Runner,{shape:[{x:2,y:45},{x:3,y:34},{x:10,y:24},{x:48,y:24},{x:57,y:31},{x:67,y:32},{x:77,y:36},{x:77,y:43}],headlights:{x:76,y:38},brakelights:{x:4,y:39},extension:{left:2,right:77},width:75,bottom:55}],[a.bmwE36M3,{shape:[{x:4,y:45},{x:6,y:38},{x:11,y:38},{x:24,y:32},{x:41,y:32},{x:57,y:40},{x:71,y:42},{x:74,y:47}],headlights:{x:72,y:45},brakelights:{x:6,y:42},extension:{left:4,right:74},width:70,bottom:55}]]);const g={detectCircleCircleCollision:(e,a)=>Math.hypot(e.loc.x-a.loc.x,e.loc.y-a.loc.y)-e.radius-a.radius<1,detectCircleHeroCollision:(e,a)=>{var t=i[d].shape.map(e=>({x:a.loc.x+e.x,y:a.loc.y+e.y}));return g.polyCircle(t,e.loc.x,e.loc.y,e.radius)},detected:e=>{const r=(e,a)=>{var[t,...e]=e;return void 0!==t&&(g.detectCircleHeroCollision(t,a)||r(e,a))};return r(e.comets,e.hero)},polyCircle:(a,t,r,o)=>{let n=0;for(let e=0;e<a.length;e++)if(n=e+1,n==a.length&&(n=0),g.lineCircle(a[e].x,a[e].y,a[n].x,a[n].y,t,r,o))return!0;return!1},lineCircle:(e,a,t,r,o,n,s)=>{var c=g.pointCircle(e,a,o,n,s),l=g.pointCircle(t,r,o,n,s);if(c||l)return!0;c=e-t,l=a-r,c=((o-e)*(t-e)+(n-a)*(r-a))/Math.sqrt(c*c+l*l)**2,l=e+c*(t-e),c=a+c*(r-a);if(!g.linePoint(e,a,t,r,l,c))return!1;o=l-o,n=c-n;return Math.sqrt(o*o+n*n)<=s},linePoint:(e,a,t,r,o,n)=>{var s=Math.hypot(o-e,n-a),n=Math.hypot(o-t,n-r),r=Math.hypot(e-t,a-r);return r-.1<=s+n&&s+n<=r+.1},pointCircle:(e,a,t,r,o)=>Math.hypot(e-t,a-r)<=o};var t=g;const o={getRandomInt:(e,a)=>Math.floor(a()*e),generate:(e,a,t)=>{var r=1+o.getRandomInt(2,t);return[...Array(r).keys()].map(()=>o.new(e,a,t))},new:(e,a,t)=>{var r=t()*e,o=10*t()+10,e={x:r,y:-o},r=t(),r=r<=.33?"#FFAA00":r<=.66?"#FC9303":"#FF7B00",t=-1*(t()+.5);return{loc:e,radius:o,color:r,dy:10,dx:t,yLimit:a,rotation:Math.atan(Math.abs(t)/10)}},update:e=>{var a=e.loc.y+e.dy,t=e.loc.x+e.dx,t={...e.loc,y:a,x:t};return{...e,loc:t}},updateAll:e=>{const r=(e,a)=>{var[t,...e]=e;return void 0===t?a:t.loc.y<=t.yLimit+346?r(e,a.concat([o.update(t)])):r(e,a)};return r(e,[])}};var h=o;const w=innerWidth<508?innerWidth:508,f=innerHeight<500?innerHeight:500,l={new:()=>({loc:{x:5-i[d].extension.left,y:f-i[d].bottom-100},dx:0,width:i[d].width,color:"#959088",swayCounter:0,isIdling:!0,isBraking:!1,drift:0,distanceTravelled:0}),update:e=>{const a=l.calcSway(e.swayCounter),t=e.loc.x-i[d].extension.left<=5+a,r=e.loc.x+i[d].extension.right>w,o=e.dx<0,n=0==e.dx,s=e.drift+.1,c=s+e.loc.x/20;if(r){const a=0,t=w-i[d].extension.right,r={...e.loc,x:t},n=!1,l=360;return{...e,loc:r,dx:0,isIdling:!1,isBraking:o,drift:s,distanceTravelled:c,swayCounter:360}}if(t&&(n||o)){const a=(e.swayCounter+1)%360,t=0,r=5+l.calcSway(a),n=0<=r?r-i[d].extension.left:0-i[d].extension.left,w={...e.loc,x:n};return{...e,loc:w,dx:0,swayCounter:a,isIdling:!0,isBraking:o,drift:s,distanceTravelled:c}}{const a=e.dx+-.8,t=e.loc.x+a,d=0<=t?t:0,i={...e.loc,x:d},r=!1,n=360;return{...e,loc:i,dx:a,isIdling:!1,isBraking:o,drift:s,distanceTravelled:c,swayCounter:360}}},rev:e=>({...e,dx:10}),calcSway:e=>5*Math.sin(Math.PI/180*5*e)};var m=l;let r;r={Background:0,0:"Background",Comet:1,1:"Comet"};var c=r,x={x:w/2,color:"#fffce3",align:"center"};const u={drawCircle:(e,a,t,r,o)=>{e.beginPath(),e.arc(a,t,r,0,2*Math.PI,!1),e.fillStyle=o,e.fill()},drawText:(e,a,t={})=>{t={...a,...t};e.fillStyle=t.color,e.font=t.fontSize+"px PressStart",e.textAlign=t.align,e.fillText(t.copy,t.x,t.y)},drawCenteredText:(e,a,t,r,o,n={})=>{r=t+r/2+o/2;u.drawText(e.ctx,{...x,copy:a,y:r,fontSize:o},n)},drawDeadCenteredText:(e,a,t,r={})=>{var o=(f+t)/2;u.drawText(e.ctx,{...x,copy:a,y:o,fontSize:t},r)},drawCenteredPhrases:(t,e,a,r,o,n={})=>{const s=a+r/2+o/2;e.forEach((e,a)=>{a=s+a*o*1.1;u.drawText(t.ctx,{...x,copy:e,y:a,fontSize:o},n)})},drawStretchedImage:(e,a,t={})=>{t={...a,...t};e.ctx.drawImage(t.img,t.x,t.y,t.targetWidth,t.targetHeight)},drawImage:(e,a,t,r,o={})=>{a={img:a,x:t,y:r,targetWidth:a.width,targetHeight:a.height};u.drawStretchedImage(e,a,o)},drawCenteredImage:(e,a,t,r,o={})=>{var n=r/a.width,n=a.height*n,n={img:a,x:(w-r)/2,y:t,targetWidth:r,targetHeight:n};u.drawStretchedImage(e,n,o)},drawDeadCenteredImage:(e,a,t,r={})=>{var o=t/a.width,o=a.height*o,o=(f-o)/2;u.drawCenteredImage(e,a,o,t,r)},drawFullWidthDeadCenteredImage:(e,a,t={})=>{u.drawDeadCenteredImage(e,a,w,t)},clearScreen:e=>{u.eraseAllScreen(e),u.fillBackground(e,"#12110b")},eraseScreen:e=>{e.ctx.clearRect(0,0,w,f)},eraseAllScreen:e=>{u.eraseScreen(e,0,0,w,f)},fillDefaultBackground:e=>{u.fillBackground(e,"#12110b")},fillBackground:(e,a)=>{e.ctx.fillStyle=a,e.ctx.fillRect(0,0,w,f)}};var p=u;const v={drawHero:(e,a)=>{const t=e.carImages[0];if(e.ctx.drawImage(t,a.loc.x,a.loc.y),a.isBraking){const t=a.loc.x+i[d].brakelights.x,r=a.loc.y+i[d].brakelights.y;p.drawCircle(e.ctx,t,r,10,"rgb(255, 0, 0, 0.35)"),p.drawCircle(e.ctx,t,r,20,"rgb(255, 0, 0, 0.15)")}},drawExhaust:(a,e)=>{e.forEach(e=>{p.drawCircle(a,e.loc.x,e.loc.y,e.radius,e.alphaColor.color())})},drawComets:(s,e)=>{e.forEach(e=>{var a=2*e.radius/100,t=s.assets[c.Comet],r=e.loc.x-130*a*.5,o=e.loc.y-346*a*.8,n=130*a,a=346*a;s.ctx.translate(e.loc.x,e.loc.y),s.ctx.rotate(e.rotation),s.ctx.drawImage(t,r-e.loc.x,o-e.loc.y,n,a),s.ctx.rotate(-e.rotation),s.ctx.translate(-e.loc.x,-e.loc.y)})},drawForeground:(t,e)=>{e.rear.concat(e.mid).concat(e.fore).forEach(e=>{var a=t.nightImages[e.imageIndex];p.drawImage(t,a,e.loc.x,e.loc.y)})},drawHeadlights:(t,e,a)=>{var r=e.loc.x+i[d].headlights.x,o=e.loc.y+i[d].headlights.y,n=o-250,e=o+70;t.ctx.save(),t.ctx.beginPath(),t.ctx.moveTo(r,o),t.ctx.lineTo(r+500,n),t.ctx.lineTo(r+500,e),t.ctx.clip(),a.fore.forEach(e=>{var a=t.dayImages[e.imageIndex];p.drawImage(t,a,e.loc.x,e.loc.y)}),t.ctx.restore()},drawBackgroundImage:e=>{var a=e.assets[c.Background];p.drawFullWidthDeadCenteredImage(e,a)},drawDistanceTravelled:(e,a)=>{var t=a+"m",a=w-10;p.drawText(e.ctx,{...x,copy:t,x:a,y:35,fontSize:25,align:"right"})},drawMontage:(a,t)=>e=>p.drawFullWidthDeadCenteredImage(a,t[e]),drawIntro:e=>{var a=.33*f,t=e.carImages[1],r=.9*w,o=.1*a,n=0+o,s=a-o,a=n+s,o=.2*s;p.clearScreen(e),p.drawCenteredImage(e,t,a,r),p.drawCenteredText(e,"1994 4Runner",n,s,o)},getGameOverDrawers:(e,a)=>{const t=.33*f,r=e.carImages[1],o=(f-r.height)/2,n=r.height,s=0+.1*t,c=o-s,l=o+n,d=.5*(f-l),i=l+d,g=f-i,h=.9*c,m=.2*d,x=m+"px PressStart",u=`You were killed by flying molten lava after travelling ${a}m`,y=v.breakCopyIntoPhrases(e.ctx,u,x,.75*w);return[()=>p.drawCenteredText(e,"RIP",s,c,h),()=>p.drawCenteredImage(e,r,o,r.width),()=>p.drawCenteredPhrases(e,y,l,d,m),i,g]},breakCopyIntoPhrases:(n,e,a,t)=>{n.font=a;const s=t,c=(e,a,t)=>{var[r,...e]=e;if(void 0===r)return t.concat([a.join(" ")]);const o=a.concat([r]);return n.measureText(o.join(" ")).width<s?c(e,o,t):c(e,[],t.concat([o.join(" ")]))};return c(e.split(" "),[],[])}};var y=v;let n;n={Locked:0,0:"Locked",ClickToStart:1,1:"ClickToStart",Playing:2,2:"Playing"};var C=n;var s=()=>{var e={loc:{x:0,y:f-375-50},imageIndex:0},a={loc:{x:0,y:f-375-50-25},imageIndex:0},t={loc:{x:0,y:f-375-50-50},imageIndex:0};return{fore:[e,{...e,loc:{...e.loc,x:762}}],mid:[a,{...a,loc:{...a.loc,x:762}}],rear:[t,{...t,loc:{...t.loc,x:762}}]}},I=e=>{const c=(e,a,t)=>{var[r,...o]=e;if(void 0===r)return a;var n=r.loc.x+t;if(-762<n){const s={...r.loc,x:n};return c(o,a.concat([{...r,loc:s}]),t,l)}e=l(),n={...r.loc,x:n+1524};return c(o,a.concat([{...r,imageIndex:e,loc:n}]),t,l)},l=()=>.6<Math.random()?1+Math.floor(7*Math.random()):0;return{fore:c(e.fore,[],-5,l),mid:c(e.mid,[],-2.5),rear:c(e.rear,[],-1.25)}},k=class{constructor(e,a,t,r){this.color=()=>`rgb(${this.r}, ${this.g}, ${this.b}, ${this.alpha})`,this.r=e,this.g=a,this.b=t,this.alpha=r}};const S={new:(e,a,t,r,o)=>({loc:e,radius:a,alphaColor:o,dx:t,dy:r,age:0}),maybeNewCarExhaust:(a,e)=>{const t=S.calcAlpha(0),r=new k(100,150,200,t),o=e?S.lowLikelihoodOfSmoke():S.highLikelihoodOfSmoke(),n=Math.random()-.5;return o.map(e=>S.new(a,e,-10,n,r))},maybeNewCometExhaust:a=>{const e=S.calcAlpha(0),t=new k(100,150,200,e);return S.highLikelihoodOfSmoke().map(e=>S.new(a,e,1,-15,t))},update:e=>{var a=e.loc.x+e.dx,t=e.loc.y+e.dy,r={...e.loc,x:a,y:t},o=e.age+1,a=S.calcAlpha(o),t=new k(e.alphaColor.r,e.alphaColor.g,e.alphaColor.b,a),a=e.radius+1;return{...e,loc:r,age:o,alphaColor:t,radius:a}},updateAll:e=>e.flatMap(e=>{var a=100<e.age,t=e.loc.x+e.radius<0,r=e.loc.y+e.radius<0;return a||t||r?[]:[S.update(e)]}),highLikelihoodOfSmoke:()=>.01<Math.random()?[25*Math.random()]:[],lowLikelihoodOfSmoke:()=>.75<Math.random()?[10*Math.random()]:[],calcAlpha:e=>.00133*(100-4*e)};var b=S,M=()=>({hero:m.new(),carExhaust:[],cometExhaust:[],comets:[],foreground:s(),cometRand:(a=>{let t=2654435769,r=608135816,o=3084996962;var n=()=>{t>>>=0,r>>>=0,o>>>=0;var e=t+r|0;return t=r^r>>>9,r=o+(o<<3)|0,o=o<<21|o>>>11,e=e+(a=1+(a>>>0)|0)|0,o=o+e|0,(e>>>0)/4294967296};for(let e=0;e<15;e++)n();return n})(3735928559)}),P=(e,a)=>{const t=m.update(e.hero),r=h.updateAll(e.comets),o=r.flatMap(e=>b.maybeNewCometExhaust(e.loc)),n=b.updateAll(e.cometExhaust).concat(o),s=b.maybeNewCarExhaust({x:e.hero.loc.x+i[d].brakelights.x,y:e.hero.loc.y+i[d].brakelights.y},e.hero.isIdling),c=b.updateAll(e.carExhaust).concat(s),l=I(e.foreground);a({...e,hero:t,carExhaust:c,cometExhaust:n,comets:r,foreground:l})};const T={getMontageDrawers:(t,e)=>{const a=y.drawMontage(t,e),r=e[0].height,o=()=>{var e=(f-r)/2+r,a=f-e;p.drawCenteredText(t,"skip",e,a,.12*a,{color:"#929082"})},n=async e=>{p.clearScreen(t),o(),await E(1),a(e),await E(2)};return[async()=>{p.clearScreen(t);var e=.33*f,a=.33*f;p.drawCenteredText(t,"joey stockermans 2022",e,a,.12*a),o(),await E(2)},()=>n(0),()=>n(1),()=>n(2),()=>n(3),()=>n(4),()=>n(5),()=>n(6),async()=>{p.clearScreen(t),await E(1);var e=.33*f,a=.33*f;p.drawCenteredText(t,"Escape from Las Palmas",e,a,.12*a),await E(2)},async()=>{var e=.66*f,a=.33*f;p.drawCenteredText(t,"Press start",e,a,.12*a)}]},drawGameOver:(a,t,e)=>{const[r,o,n,s,c]=y.getGameOverDrawers(t,Math.floor(e));(async()=>{await E(1),p.clearScreen(t),r(),o(),n(),await E(1),a(C.ClickToStart);var e=.2*c;p.drawCenteredText(t,"Ok",s,c,e)})()},draw:(e,a)=>{p.clearScreen(a),y.drawBackgroundImage(a),y.drawForeground(a,e.foreground),y.drawDistanceTravelled(a,Math.floor(e.hero.distanceTravelled)),y.drawHero(a,e.hero),y.drawHeadlights(a,e.hero,e.foreground),y.drawExhaust(a.ctx,e.carExhaust.concat(e.cometExhaust)),y.drawComets(a,e.comets)},startNewGame:(e,a)=>{e(M()),a(C.Playing)},revEngine:(e,a)=>{var t=m.rev(e.hero);a({...e,hero:t})},addComets:(e,a)=>{var t=e.comets.concat(h.generate(w,f,e.cometRand));a({...e,comets:t})},addCometTime:(e,a)=>200<=e-a&&e%125==0},E=a=>new Promise(e=>setTimeout(e,1e3*a));var A=T,B=["../assets/misc/background.png","../assets/misc/comet.png"].map(t=>new Promise(e=>{const a=new Image;a.onload=()=>e(a),a.src=t})),R=Promise.all(B),B=["../assets/foreground/night.png","../assets/foreground/night_v1.png","../assets/foreground/night_v2.png","../assets/foreground/night_v3.png","../assets/foreground/night_v4.png","../assets/foreground/night_v5.png","../assets/foreground/night_v6.png","../assets/foreground/night_v7.png"].map(t=>new Promise(e=>{const a=new Image;a.onload=()=>e(a),a.src=t})),F=Promise.all(B),B=["../assets/foreground/day.png","../assets/foreground/day_v1.png","../assets/foreground/day_v2.png","../assets/foreground/day_v3.png","../assets/foreground/day_v4.png","../assets/foreground/day_v5.png","../assets/foreground/day_v6.png","../assets/foreground/day_v7.png"].map(t=>new Promise(e=>{const a=new Image;a.onload=()=>e(a),a.src=t})),D=Promise.all(B),B=["../assets/montage/01.png","../assets/montage/02.png","../assets/montage/03.png","../assets/montage/04.png","../assets/montage/05.png","../assets/montage/06.png","../assets/montage/07.png"].map(t=>new Promise(e=>{const a=new Image;a.onload=()=>e(a),a.src=t})),_=Promise.all(B),a=Object.fromEntries([[a.toyota2ndGen4Runner,["../assets/car/toyota2ndGen4Runner/small.png","../assets/car/toyota2ndGen4Runner/large.png"]],[a.bmwE36M3,["../assets/car/bmwE36M3/small.png","../assets/car/bmwE36M3/large.png"]]])[d].map(t=>new Promise(e=>{const a=new Image;a.onload=()=>e(a),a.src=t})),G=Promise.all(a),a=[{name:"PressStart",url:"url(../assets/fonts/PressStart2P-Regular.ttf)"}].map(e=>new FontFace(e.name,e.url).load()),L=Promise.all(a),O=(e,a,t,r,o,n)=>{e.width=w,e.height=f,document.fonts.add(n[0]);var s=(e=>{if(e)return e;throw new Error("Failed to get 2D context")})(e.getContext("2d"));return{canvas:e,ctx:s,assets:a,nightImages:t,dayImages:r,carImages:o,fonts:n}};const H=document.getElementById("game");let W;const j=e=>{W=e};let N,z=C.ClickToStart;const $=e=>{z=e};let q=0;R.then(n=>{G.then(o=>{F.then(r=>{D.then(t=>{_.then(a=>{L.then(e=>{N=O(H,n,r,t,o,e);e=A.getMontageDrawers(N,a);J(e)})})})})})});const Y=()=>{var e=requestAnimationFrame(Y);A.addCometTime(e,q)&&A.addComets(W,j),P(W,j),A.draw(W,N),t.detected(W)&&(cancelAnimationFrame(e),q=e,$(C.Locked),A.drawGameOver($,N,W.hero.distanceTravelled))},J=e=>{const[a,...t]=e;void 0!==a&&a().then(()=>{z!=C.Playing&&J(t)})};H.addEventListener("click",()=>{switch(z){case C.Locked:break;case C.ClickToStart:A.startNewGame(j,$),Y();break;case C.Playing:A.revEngine(W,j)}})})();